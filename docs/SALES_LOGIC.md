# Логика учёта продаж

## Проблема

Сотрудник может работать на нескольких точках продаж. Например:
- Ибрагимов Н.Б. продаёт и в ЦУМе, и в Онлайн

Если фильтровать сотрудников по их "домашнему" отделу, теряются продажи на других точках.

## Правильная логика

### Ключевой принцип: "Продажи по магазину, а не по отделу сотрудника"

Каждая продажа содержит `retail_store_id` - ID магазина где была сделана продажа.
Это позволяет правильно атрибутировать продажи независимо от "домашнего" отдела сотрудника.

### 1. Страница отдела (Team API) - `/api/team`

**Логика:** Показываем ВСЕХ, кто продавал в магазинах этого отдела.

```
/api/team?department=online

1. Получить ВСЕ продажи в магазинах Online за период (фильтр по retail_store_id)
2. Собрать уникальные moysklad_id сотрудников из этих продаж
3. Загрузить данные этих сотрудников (независимо от их "домашнего" отдела)
4. Показать их в рейтинге отдела
```

**Результат:** Ибрагимов появляется в Online со своими 107 продажами там.

### 2. Страница профиля сотрудника (Employee API) - `/api/employee/[moyskladId]`

**Логика:** Показываем ВСЕ продажи сотрудника по ВСЕМ магазинам.

```
/api/employee/[moyskladId]

1. Получить ВСЕ продажи сотрудника за период (БЕЗ фильтра по магазину!)
2. Это даёт полную картину работы сотрудника
3. Позиция в рейтинге считается относительно "домашнего" отдела
```

**Результат:** Ибрагимов видит свои 131 продажу (24 ЦУМ + 107 Онлайн).

### 3. Monthly Rankings (Sync Full API) - `/api/sync/full`

**Логика:** Рейтинг отдела = все кто продавал в магазинах отдела.

```
calculateAndSaveRankings(period)

1. Для каждого отдела получить продажи в его магазинах
2. Собрать уникальных сотрудников из этих продаж
3. Рассчитать net sales для каждого
4. Сохранить в monthly_rankings
```

### 4. Достижения (Achievements API) - `/api/achievements/calculate`

**Логика:** Достижения рассчитываются по ВСЕМ продажам сотрудника.

```
1. Получить ВСЕХ сотрудников
2. Получить ВСЕ продажи за период (без фильтра по магазину)
3. Проверить достижения для каждого
```

## Структура данных

Каждая продажа содержит 3 ключевых поля:

```json
{
  "moysklad_employee_id": "xxx",    // КТО продал
  "retail_store_id": "yyy",          // ГДЕ продал
  "amount": 25000                    // СКОЛЬКО
}
```

## Маппинг магазинов

```typescript
const DEPARTMENT_STORE_IDS: Record<DepartmentType, string[]> = {
  moscow: ['b9585357-b51b-11ee-0a80-15c6000bc3b8'],
  tsum: ['b5a56c15-b162-11ee-0a80-02a00015a9f3'],
  online: [
    'd491733b-b6f8-11ee-0a80-033a0016fb6b',    // Онлайн Продажи
    'd1b4400d-007b-11ef-0a80-14800035ff62',    // Online New
    'a5ed2d1e-79bc-11f0-0a80-01e0001ceb81'     // Онлайн Астана
  ],
}
```

## Проверка корректности данных

### 1. Сверка по магазину

```
Все продажи Online = Сумма всех сотрудников в Online

Online общая:           298 чеков,  5,105,167 тг
├── Кадыков Н. С.:      174 чека,   2,668,522 тг
├── Ибрагимов Н. Б.:    107 чеков,  2,177,815 тг
├── Саврукова Ж. Ж.:     15 чеков,    140,200 тг
└── ИТОГО:              298 чеков,  5,105,167 тг  ✅
```

### 2. Сверка по сотруднику

```
Все продажи Ибрагимова = Сумма его продаж по всем точкам

Ибрагимов всего:        131 чек,   2,744,160 тг
├── в Online:           107 чеков, 2,177,815 тг
├── в ЦУМ:               24 чека,    566,345 тг
└── ИТОГО:              131 чек,   2,744,160 тг  ✅
```

### 3. Глобальная сверка

```
ВСЕ продажи = Сумма по магазинам = Сумма по сотрудникам
```

## Файлы с логикой (проверены 2025-12-05)

| Файл | Статус | Описание |
|------|--------|----------|
| `/src/app/api/team/route.ts` | ✅ | Рейтинг отдела по магазинам |
| `/src/app/api/employee/[moyskladId]/route.ts` | ✅ | Профиль: ВСЕ продажи сотрудника |
| `/src/app/api/employee/[moyskladId]/daily/route.ts` | ✅ | Статистика по дням |
| `/src/app/api/sync/full/route.ts` | ✅ | Rankings по магазинам |
| `/src/app/api/sync/sales/route.ts` | ✅ | Импорт с retail_store_id |
| `/src/app/api/sync/returns/route.ts` | ✅ | Импорт возвратов |
| `/src/app/api/achievements/calculate/route.ts` | ✅ | Достижения по всем продажам |

## Типичные ошибки (НЕ ДЕЛАТЬ!)

### ❌ Неправильно: Фильтровать сотрудников по отделу сначала

```typescript
// НЕПРАВИЛЬНО!
const employees = await supabase
  .from('employees')
  .eq('department', department)  // Потеряем кроссовые продажи!

const sales = await supabase
  .from('sales')
  .in('moysklad_employee_id', employees.map(e => e.moysklad_id))
```

### ✅ Правильно: Сначала продажи по магазину, потом сотрудники

```typescript
// ПРАВИЛЬНО!
const sales = await supabase
  .from('sales')
  .in('retail_store_id', DEPARTMENT_STORE_IDS[department])

const uniqueEmployeeIds = [...new Set(sales.map(s => s.moysklad_employee_id))]

const employees = await supabase
  .from('employees')
  .in('moysklad_id', uniqueEmployeeIds)  // Все кто продавал!
```

## История изменений

- **2025-12-05:** Полная проверка и исправление логики во всех API
  - Исправлен team/route.ts - продажи по магазину
  - Исправлен employee/route.ts - все продажи сотрудника
  - Исправлен sync/full/route.ts - rankings по магазинам
  - Добавлена документация с примерами
